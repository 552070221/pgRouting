<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Contraction &mdash; pgRouting Manual (2.3.0-dev) (test/appveyor)</title>
    
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.3.0 (test/appveyor)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="pgRouting Manual (2.3.0-dev) (test/appveyor)" href="../../../index.html" />
    <link rel="up" title="Experimental and Proposed functions" href="../../proposed.html" />
    <link rel="next" title="pgr_contractGraph - Proposed" href="pgr_contractGraph.html" />
    <link rel="prev" title="Experimental and Proposed functions" href="../../proposed.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../../_static/pgrouting.png" alt="Logo"/><h1 class="heading"><a href="../../../index.html">
          <span>pgRouting Manual (2.3.0-dev) (test/appveyor)</span></a></h1>
        <h2 class="heading"><span>Contraction</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="../../proposed.html">Experimental and Proposed functions</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../../doc/index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pgr_contractGraph.html">pgr_contractGraph - Proposed</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="contraction">
<span id="id1"></span><h1>Contraction<a class="headerlink" href="#contraction" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>These are proposed functions</p>
<ul class="last simple">
<li>They are not officially of the current release.</li>
<li>They likely will not be officially be part of the next release:<ul>
<li>The functions might not make use of ANY-INTEGER and ANY-NUMERICAL</li>
<li>Name might change.</li>
<li>Signature might change.</li>
<li>Functionality might change.</li>
<li>pgTap tests might be missing.</li>
<li>Might need c/c++ coding.</li>
<li>May lack documentation.</li>
<li>Documentation if any might need to be rewritten.</li>
<li>Documentation examples might need to be automatically generated.</li>
<li>Might need a lot of feedback from the comunity.</li>
<li>Might depend on a proposed function of pgRouting</li>
<li>Might depend on a deprecated function of pgRouting</li>
</ul>
</li>
</ul>
</div>
<p><a class="reference internal" href="pgr_contractGraph.html#pgr-contractgraph"><em>pgr_contractGraph - Proposed</em></a></p>
<p>Graph Contraction, when talking about big graphs, like the road graphs, or electric networks, can be used to speed up, some graph algorithms.</p>
<p>The contraction level and contraction operations can become very complex, as the complexity
of the graphs grows.</p>
<p>For this proposal, we are making our contraction algorithm simple as possible so that
more contraction operations can be added in the future.</p>
<p>We are not aiming with this work to implement all the possible contraction operations
but to give a framework such that adding a contraction operation can be easily achieved.</p>
<p>For this contraction proposal I am only making 2 operations:</p>
<blockquote>
<div><ol class="arabic simple">
<li>dead end contraction: vertices have one incoming edge</li>
<li>linear contraction: vertices have one incoming and one outgoing edge</li>
</ol>
</div></blockquote>
<p>And with the additional characteristics:</p>
<blockquote>
<div><ul class="simple">
<li>The user can forbid to contract a particular set of nodes or edges.</li>
<li>The user can decide how many times the cycle can be done.</li>
<li>If possible, the user can decide the order of the operations on a cycle.</li>
</ul>
</div></blockquote>
<div class="section" id="the-contraction-skeleton">
<h2>The contraction skeleton<a class="headerlink" href="#the-contraction-skeleton" title="Permalink to this headline">¶</a></h2>
<p>In general we have an initial set up that may involve analizing the graph given as input and setting the
non contractable nodes or edges. We have a cycle that will go and perform a contraction operation
until while possible, and then move to the next contraction operation.
Adding a new operation then becomes an &#8220;easy&#8221; task; more things might be involved, because the
charachteristics of the graph change each time its contracted, so some interaction between contractions
has to be implemented also.</p>
<p>Currently, there are two implemented operation for contracting a graph</p>
<ul class="simple">
<li>Dead End contraction</li>
<li>Linear contraction</li>
</ul>
</div>
<div class="section" id="dead-end-contraction">
<h2>Dead end contraction<a class="headerlink" href="#dead-end-contraction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dead-end-nodes">
<h3>Dead end nodes<a class="headerlink" href="#dead-end-nodes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The green node <tt class="docutils literal"><span class="pre">B</span></tt> represents a dead end node</li>
<li>The node <tt class="docutils literal"><span class="pre">A</span></tt> is the only node connecting to <tt class="docutils literal"><span class="pre">B</span></tt>.</li>
<li>Node <tt class="docutils literal"><span class="pre">A</span></tt> is part of the rest of the graph and has an unlimited number of incoming and outgoing edges.</li>
<li>Directed graph</li>
</ul>
<p class="graphviz">
<img src="../../../_images/graphviz-5234bd53dd71aa73dcdf49a40867bf76cd7eeece.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=green];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    A -&gt; B;
}" />
</p>
</div>
<div class="section" id="operation-dead-end-contraction">
<h3>Operation: Dead End Contraction<a class="headerlink" href="#operation-dead-end-contraction" title="Permalink to this headline">¶</a></h3>
<p>The dead end contraction will stop until there are no more dead end nodes.
For example from the following graph:</p>
<ul class="simple">
<li>Node <tt class="docutils literal"><span class="pre">A</span></tt> is connected to the rest of the graph by an unlimited number of edges.</li>
<li>Node <tt class="docutils literal"><span class="pre">B</span></tt> is connected to the rest of the graph with one incoming edge.</li>
<li>The green node <tt class="docutils literal"><span class="pre">C</span></tt> represents a <cite>Dead End</cite> node</li>
</ul>
<p class="graphviz">
<img src="../../../_images/graphviz-2fc5bee4aea052d2d99303cc04e3d2bd3b719d10.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=deepskyblue];
    C [style=filled; color=green];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    A -&gt; B;
    B -&gt; C;
}" />
</p>
<p>After contracting <tt class="docutils literal"><span class="pre">B</span></tt>, node <tt class="docutils literal"><span class="pre">C</span></tt> is now a <cite>Dead End</cite> and is contracted:</p>
<p class="graphviz">
<img src="../../../_images/graphviz-c1fa41046ff4a91086fcef9533739ae0c21423e8.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=green;label=&quot;B {C}&quot;;];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    A -&gt; B;
}" />
</p>
<p>Node <tt class="docutils literal"><span class="pre">B</span></tt> gets contracted</p>
<p class="graphviz">
<img src="../../../_images/graphviz-b06b0c770fa8f090fe488e5e05ad95accde5f494.png" alt="digraph G {
    A [style=filled;color=deepskyblue;label=&quot;A {B, C}&quot;;];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
}" />
</p>
<p>Nodes <tt class="docutils literal"><span class="pre">B</span></tt> and <tt class="docutils literal"><span class="pre">C</span></tt> belong to node <tt class="docutils literal"><span class="pre">A</span></tt>.</p>
</div>
<div class="section" id="not-dead-end-nodes">
<h3>Not Dead End nodes<a class="headerlink" href="#not-dead-end-nodes" title="Permalink to this headline">¶</a></h3>
<p>In the next graph <tt class="docutils literal"><span class="pre">B</span></tt> is not a <cite>dead end</cite> node.</p>
<p class="graphviz">
<img src="../../../_images/graphviz-34238e76a3c7511d025e441305a318f778738bfe.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=red];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    G -&gt; A [dir=none, weight=1, penwidth=3];
    B -&gt; A;
}" />
</p>
</div>
</div>
<div class="section" id="linear-contraction">
<h2>Linear contraction<a class="headerlink" href="#linear-contraction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="linear-nodes">
<h3>Linear nodes<a class="headerlink" href="#linear-nodes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The green node <tt class="docutils literal"><span class="pre">B</span></tt> represents a linear node</li>
<li>The nodes <tt class="docutils literal"><span class="pre">A</span></tt> and <tt class="docutils literal"><span class="pre">C</span></tt> are the only nodes connecting to <tt class="docutils literal"><span class="pre">B</span></tt>.</li>
<li>Node <tt class="docutils literal"><span class="pre">A</span></tt> is part of the rest of the graph and has an unlimited number of incoming and outgoing edges.</li>
<li>Node <tt class="docutils literal"><span class="pre">C</span></tt> is part of the rest of the graph and has an unlimited number of incoming and outgoing edges.</li>
<li>Directed graph</li>
</ul>
<p class="graphviz">
<img src="../../../_images/graphviz-6a336f179d0b0145fe69070034f6227227050025.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=green];
    C [style=filled;color=deepskyblue];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    G -&gt; C [dir=none, weight=1, penwidth=3];
    A -&gt; B;
    B -&gt; C;
}" />
</p>
</div>
<div class="section" id="operation-linear-contraction">
<h3>Operation: Linear Contraction<a class="headerlink" href="#operation-linear-contraction" title="Permalink to this headline">¶</a></h3>
<p>The linear contraction will stop until there are no more linear nodes.
For example from the following graph:</p>
<ul class="simple">
<li>Node <tt class="docutils literal"><span class="pre">A</span></tt> is connected to the rest of the graph by an unlimited number of edges.</li>
<li>Node <tt class="docutils literal"><span class="pre">B</span></tt> is connected to the rest of the graph with one incoming edge and one outgoing edge.</li>
<li>Node <tt class="docutils literal"><span class="pre">C</span></tt> is connected to the rest of the graph with one incoming edge and one outgoing edge.</li>
<li>Node <tt class="docutils literal"><span class="pre">D</span></tt> is connected to the rest of the graph by an unlimited number of edges.</li>
<li>The green nodes <tt class="docutils literal"><span class="pre">B</span></tt> and <tt class="docutils literal"><span class="pre">C</span></tt> represents <cite>Linear</cite> nodes.</li>
</ul>
<p class="graphviz">
<img src="../../../_images/graphviz-ecc4fb2219f4664e6a65401d4248e7fbed6cc8a5.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=green];
    C [style=filled; color=green];
    D [style=filled; color=deepskyblue];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    G -&gt; D [dir=none, weight=1, penwidth=3];
    A -&gt; B;
    B -&gt; C;
    C -&gt; D;

}" />
</p>
<p>After contracting <tt class="docutils literal"><span class="pre">B</span></tt>, a new edge gets inserted between <tt class="docutils literal"><span class="pre">A</span></tt> and <tt class="docutils literal"><span class="pre">C</span></tt> which is represented by red color.</p>
<p class="graphviz">
<img src="../../../_images/graphviz-d4a7d13cd6b20a3317ca8decd49284c6cfe2cc6d.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    C [style=filled; color=green];
    D [style=filled; color=deepskyblue];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    G -&gt; D [dir=none, weight=1, penwidth=3];
    A -&gt; C [label=&quot;{B}&quot;;color=red]
    C -&gt; D;

}" />
</p>
<p>Node <tt class="docutils literal"><span class="pre">C</span></tt> is <cite>linear node</cite> and gets contracted.</p>
<p class="graphviz">
<img src="../../../_images/graphviz-670a660fa776683b3a296840290d645cdc970e32.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    D [style=filled; color=deepskyblue];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    G -&gt; D [dir=none, weight=1, penwidth=3];
    A -&gt; D [label=&quot;{B, C}&quot;;color=red];

}" />
</p>
<p>Nodes <tt class="docutils literal"><span class="pre">B</span></tt> and <tt class="docutils literal"><span class="pre">C</span></tt> belong to edge connecting <tt class="docutils literal"><span class="pre">A</span></tt> and <tt class="docutils literal"><span class="pre">D</span></tt> which is represented by red color.</p>
</div>
<div class="section" id="not-linear-nodes">
<h3>Not Linear nodes<a class="headerlink" href="#not-linear-nodes" title="Permalink to this headline">¶</a></h3>
<p>In the next graph <tt class="docutils literal"><span class="pre">B</span></tt> is not a <cite>linear</cite> node.</p>
<p class="graphviz">
<img src="../../../_images/graphviz-033a3e1eb36d086bdf7edd1d02d4a6687beb9c8d.png" alt="digraph G {
    A [style=filled;color=deepskyblue];
    B [style=filled; color=red];
    C [style=filled;color=deepskyblue];
    &quot;G&quot; [shape=tripleoctagon;
    style=filled;color=deepskyblue;
    label = &quot;Rest of the Graph&quot;];

    rankdir=LR;
    G -&gt; A [dir=none, weight=1, penwidth=3];
    G -&gt; C [dir=none, weight=1, penwidth=3];
    A -&gt; B;
    C -&gt; B;
}" />
</p>
</div>
</div>
<div class="section" id="the-cyle">
<h2>The cyle<a class="headerlink" href="#the-cyle" title="Permalink to this headline">¶</a></h2>
<p>Contracting a graph, can be done with more than one operation.
The order of the operations affect the resulting contracted graph, and after applying one operation, new vertices can be contracted in another operation.</p>
<p>This implementation, cycles <tt class="docutils literal"><span class="pre">max_cycles</span></tt> times  through <tt class="docutils literal"><span class="pre">operations_order</span></tt> .</p>
<div class="highlight-none"><div class="highlight"><pre>&lt;input&gt;
do max_cycles times {
    for (operation in operations_order)
     { do operation }
}
&lt;output&gt;
</pre></div>
</div>
</div>
<div class="section" id="contracting-sample-data">
<h2>Contracting Sample Data<a class="headerlink" href="#contracting-sample-data" title="Permalink to this headline">¶</a></h2>
<p>In this section, building an using a contracted graph will be shown by example.</p>
<ul class="simple">
<li>The <a class="reference internal" href="../../../doc/src/developer/sampledata.html#sampledata"><em>Sample Data</em></a> for an undirected graph is used</li>
<li>a dead end operation first followed by a linear linear operation.</li>
</ul>
<p>The original graph:</p>
<img alt="../../../_images/undirected_sampledata_a.png" src="../../../_images/undirected_sampledata_a.png" />
<p>After doing a dead end contraction operation:</p>
<img alt="../../../_images/undirected_sampledata_b.png" src="../../../_images/undirected_sampledata_b.png" />
<p>Doing a linear contraction operation to the graph above</p>
<img alt="../../../_images/undirected_sampledata_c.png" src="../../../_images/undirected_sampledata_c.png" />
<p>There are five cases, in these documentation, which arise when calculating the shortest path between a given source and target.
In this examples, pgr_dijkstra is used.</p>
<ul class="simple">
<li><strong>Case 1</strong>: Both source and target belong to the contracted graph.</li>
<li><strong>Case 2</strong>: Source belongs to a contracted graph, while target belongs to a vertex subgraph.</li>
<li><strong>Case 3</strong>: Source belongs to a contracted graph, while target belongs to an edge subgraph.</li>
<li><strong>Case 4</strong>: Source belongs to a vertex subgraph, while target belongs to an edge subgraph.</li>
<li><strong>Case 5</strong>: The path contains a new edge added by the contraction algorithm.</li>
</ul>
<div class="section" id="construction-of-the-graph-in-the-database">
<h3>Construction of the graph in the database<a class="headerlink" href="#construction-of-the-graph-in-the-database" title="Permalink to this headline">¶</a></h3>
<p class="rubric">Original Data</p>
<p>The following query shows the original data involved in the contraction operation.</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT id, source, target, cost, reverse_cost FROM edge_table;
 id | source | target | cost | reverse_cost 
----+--------+--------+------+--------------
  1 |      1 |      2 |    1 |            1
  2 |      2 |      3 |   -1 |            1
  3 |      3 |      4 |   -1 |            1
  4 |      2 |      5 |    1 |            1
  5 |      3 |      6 |    1 |           -1
  6 |      7 |      8 |    1 |            1
  7 |      8 |      5 |    1 |            1
  8 |      5 |      6 |    1 |            1
  9 |      6 |      9 |    1 |            1
 10 |      5 |     10 |    1 |            1
 11 |      6 |     11 |    1 |           -1
 12 |     10 |     11 |    1 |           -1
 13 |     11 |     12 |    1 |           -1
 14 |     10 |     13 |    1 |            1
 15 |      9 |     12 |    1 |            1
 16 |      4 |      9 |    1 |            1
 17 |     14 |     15 |    1 |            1
 18 |     16 |     17 |    1 |            1
(18 rows)
</pre></div>
</div>
<p class="rubric">Contraction Results</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM pgr_contractGraph(
    &#39;SELECT id, source, target, cost, reverse_cost FROM edge_table&#39;,
    array[1,2], directed:=true);
 seq | type | id | contracted_vertices | source | target | cost 
-----+------+----+---------------------+--------+--------+------
   1 | v    |  5 | {7,8}               |     -1 |     -1 |   -1
   2 | v    | 15 | {14}                |     -1 |     -1 |   -1
   3 | v    | 17 | {16}                |     -1 |     -1 |   -1
   4 | e    | -1 | {1,2}               |      3 |      5 |    2
   5 | e    | -2 | {4}                 |      9 |      3 |    2
   6 | e    | -3 | {10,13}             |      5 |     11 |    2
   7 | e    | -4 | {12}                |     11 |      9 |    2
(7 rows)
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO write a paragraph comparing the results with the last graph above.</p>
</div>
<p class="rubric">step 1</p>
<p>Adding extra columns to the <tt class="docutils literal"><span class="pre">edge_table</span></tt> and <tt class="docutils literal"><span class="pre">edge_table_vertices_pgr</span></tt> tables:</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Column</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>contracted_vertices</strong></td>
<td>The vertices set belonging to the vertex/edge</td>
</tr>
<tr class="row-odd"><td><strong>is_contracted</strong></td>
<td>On a <cite>vertex</cite> table: when <tt class="docutils literal"><span class="pre">true</span></tt> the vertex is contracted, so is not part of the contracted graph.</td>
</tr>
<tr class="row-even"><td><strong>is_contracted</strong></td>
<td>On an <cite>edge</cite> table: when <tt class="docutils literal"><span class="pre">true</span></tt> the edge was generated by the contraction algorithm.</td>
</tr>
</tbody>
</table>
<p>Using the following queries:</p>
<div class="highlight-python"><div class="highlight"><pre>ALTER TABLE edge_table ADD contracted_vertices BIGINT[];
ALTER TABLE
ALTER TABLE edge_table_vertices_pgr ADD contracted_vertices BIGINT[];
ALTER TABLE
ALTER TABLE edge_table ADD is_contracted BOOLEAN DEFAULT false;
ALTER TABLE
ALTER TABLE edge_table_vertices_pgr ADD is_contracted BOOLEAN DEFAULT false;
ALTER TABLE
</pre></div>
</div>
<p class="rubric">step 2</p>
<p>For simplicity, in this documentation, store the results of the call to pgr_contractGraph in a temporary table</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT * INTO contraction_results
FROM pgr_contractGraph(
    &#39;SELECT id, source, target, cost, reverse_cost FROM edge_table&#39;,
    array[1,2], directed:=true);
SELECT 7
</pre></div>
</div>
<p class="rubric">step 3</p>
<p>Update the <cite>vertex</cite> and <cite>edge</cite> tables using the results of the call to pgr_contraction</p>
<ul class="simple">
<li>In <cite>edge_table_vertices_pgr.is_contracted</cite> indicate the vertices that are contracted.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>UPDATE edge_table_vertices_pgr
SET is_contracted = true
WHERE id IN (SELECT  unnest(contracted_vertices) FROM  contraction_results);
UPDATE 10
</pre></div>
</div>
<ul class="simple">
<li>Add to <cite>edge_table_vertices_pgr.contracted_vertices</cite>  the contracted vertices belonging to the vertices.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>UPDATE edge_table_vertices_pgr
SET contracted_vertices = contraction_results.contracted_vertices
FROM contraction_results
WHERE type = &#39;v&#39; AND edge_table_vertices_pgr.id = contraction_results.id;
UPDATE 3
</pre></div>
</div>
<ul class="simple">
<li>Insert the new edges generated by  pgr_contractGraph.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>INSERT INTO edge_table(source, target, cost, reverse_cost, contracted_vertices, is_contracted)
SELECT source, target, cost, -1, contracted_vertices, true
FROM contraction_results
WHERE type = &#39;e&#39;;
INSERT 0 4
</pre></div>
</div>
<p class="rubric">step 3.1</p>
<p>Verify visually the updates.</p>
<ul class="simple">
<li>On the <cite>edge_table_vertices_pgr</cite></li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>SELECT id, contracted_vertices, is_contracted 
FROM edge_table_vertices_pgr
ORDER BY id;
 id | contracted_vertices | is_contracted 
----+---------------------+---------------
  1 |                     | t
  2 |                     | t
  3 |                     | f
  4 |                     | t
  5 | {7,8}               | f
  6 |                     | f
  7 |                     | t
  8 |                     | t
  9 |                     | f
 10 |                     | t
 11 |                     | f
 12 |                     | t
 13 |                     | t
 14 |                     | t
 15 | {14}                | f
 16 |                     | t
 17 | {16}                | f
(17 rows)
</pre></div>
</div>
<ul class="simple">
<li>On the <cite>edge_table</cite></li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>SELECT id, source, target, cost, reverse_cost, contracted_vertices, is_contracted 
FROM edge_table
ORDER BY id;
 id | source | target | cost | reverse_cost | contracted_vertices | is_contracted 
----+--------+--------+------+--------------+---------------------+---------------
  1 |      1 |      2 |    1 |            1 |                     | f
  2 |      2 |      3 |   -1 |            1 |                     | f
  3 |      3 |      4 |   -1 |            1 |                     | f
  4 |      2 |      5 |    1 |            1 |                     | f
  5 |      3 |      6 |    1 |           -1 |                     | f
  6 |      7 |      8 |    1 |            1 |                     | f
  7 |      8 |      5 |    1 |            1 |                     | f
  8 |      5 |      6 |    1 |            1 |                     | f
  9 |      6 |      9 |    1 |            1 |                     | f
 10 |      5 |     10 |    1 |            1 |                     | f
 11 |      6 |     11 |    1 |           -1 |                     | f
 12 |     10 |     11 |    1 |           -1 |                     | f
 13 |     11 |     12 |    1 |           -1 |                     | f
 14 |     10 |     13 |    1 |            1 |                     | f
 15 |      9 |     12 |    1 |            1 |                     | f
 16 |      4 |      9 |    1 |            1 |                     | f
 17 |     14 |     15 |    1 |            1 |                     | f
 18 |     16 |     17 |    1 |            1 |                     | f
 19 |      3 |      5 |    2 |           -1 | {1,2}               | t
 20 |      9 |      3 |    2 |           -1 | {4}                 | t
 21 |      5 |     11 |    2 |           -1 | {10,13}             | t
 22 |     11 |      9 |    2 |           -1 | {12}                | t
(22 rows)
</pre></div>
</div>
<ul class="simple">
<li>vertices that belong to the contracted graph are the non contracted vertices</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>SELECT id  FROM edge_table_vertices_pgr
WHERE is_contracted = false
ORDER BY id;
 id 
----
  3
  5
  6
  9
 11
 15
 17
(7 rows)
</pre></div>
</div>
<p class="rubric">case 1: Both source and target belong to the contracted graph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM pgr_dijkstra(
    $$
    WITH
    vertices_in_graph AS (
        SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false)
    SELECT id, source, target, cost, reverse_cost 
    FROM edge_table 
    WHERE source IN (SELECT * FROM vertices_in_graph)
    AND target IN (SELECT * FROM vertices_in_graph)
    $$,
    3, 11, false);
 seq | path_seq | node | edge | cost | agg_cost 
-----+----------+------+------+------+----------
   1 |        1 |    3 |    5 |    1 |        0
   2 |        2 |    6 |   11 |    1 |        1
   3 |        3 |   11 |   -1 |    0 |        2
(3 rows)
</pre></div>
</div>
<p class="rubric">case 2: Source belongs to a contracted graph, while target belongs to a vertex subgraph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM pgr_dijkstra(
    $$
    WITH
    expand_edges AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table),
    expand1 AS (SELECT contracted_vertices FROM edge_table
        WHERE id IN (SELECT id FROM expand_edges WHERE vertex = 1)),
    vertices_in_graph AS (
        SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false
        UNION
        SELECT unnest(contracted_vertices) FROM expand1)
    SELECT id, source, target, cost, reverse_cost
    FROM edge_table
    WHERE source IN (SELECT * FROM vertices_in_graph)
    AND target IN (SELECT * FROM vertices_in_graph)
    $$,
    3, 1, false);
 seq | path_seq | node | edge | cost | agg_cost 
-----+----------+------+------+------+----------
   1 |        1 |    3 |    2 |    1 |        0
   2 |        2 |    2 |    1 |    1 |        1
   3 |        3 |    1 |   -1 |    0 |        2
(3 rows)
</pre></div>
</div>
<p class="rubric">case 3: Source belongs to a contracted graph, while target belongs to an edge subgraph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM pgr_dijkstra(
    $$
    WITH

    expand_vertices AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table_vertices_pgr),
    expand7 AS (SELECT contracted_vertices FROM edge_table_vertices_pgr
        WHERE id IN (SELECT id FROM expand_vertices WHERE vertex = 7)),

    expand_edges AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table),
    expand13 AS (SELECT contracted_vertices FROM edge_table
        WHERE id IN (SELECT id FROM expand_edges WHERE vertex = 13)),

    vertices_in_graph AS (
        SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false
        UNION
        SELECT unnest(contracted_vertices) FROM expand13
        UNION
        SELECT unnest(contracted_vertices) FROM expand7)

    SELECT id, source, target, cost, reverse_cost
    FROM edge_table
    WHERE source IN (SELECT * FROM vertices_in_graph)
    AND target IN (SELECT * FROM vertices_in_graph)
    $$,
    7, 13, false);
 seq | path_seq | node | edge | cost | agg_cost 
-----+----------+------+------+------+----------
   1 |        1 |    7 |    6 |    1 |        0
   2 |        2 |    8 |    7 |    1 |        1
   3 |        3 |    5 |   10 |    1 |        2
   4 |        4 |   10 |   14 |    1 |        3
   5 |        5 |   13 |   -1 |    0 |        4
(5 rows)
</pre></div>
</div>
<p class="rubric">case 4: Source belongs to a vertex subgraph, while target belongs to an edge subgraph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM  pgr_dijkstra(
    $$
    WITH
    expand_vertices AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table_vertices_pgr),
    expand7 AS (SELECT contracted_vertices FROM edge_table_vertices_pgr
        WHERE id IN (SELECT id FROM expand_vertices WHERE vertex = 7)),
    vertices_in_graph AS (
        SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false
        UNION
        SELECT unnest(contracted_vertices) FROM expand7)
    SELECT id, source, target, cost, reverse_cost
    FROM edge_table
    WHERE source IN (SELECT * FROM vertices_in_graph)
    AND target IN (SELECT * FROM vertices_in_graph)
    $$,
    3, 7, false);
 seq | path_seq | node | edge | cost | agg_cost 
-----+----------+------+------+------+----------
   1 |        1 |    3 |   19 |    2 |        0
   2 |        2 |    5 |    7 |    1 |        2
   3 |        3 |    8 |    6 |    1 |        3
   4 |        4 |    7 |   -1 |    0 |        4
(4 rows)
</pre></div>
</div>
<p class="rubric">case 5: The path contains an edge added by the contraction algorithm.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>WITH
first_dijkstra AS (
    SELECT * FROM  pgr_dijkstra(
        $$
        WITH
        expand_vertices AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table_vertices_pgr),
        expand7 AS (SELECT contracted_vertices FROM edge_table_vertices_pgr
            WHERE id IN (SELECT id FROM expand_vertices WHERE vertex = 7)),
        vertices_in_graph AS (
            SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false
            UNION
            SELECT unnest(contracted_vertices) FROM expand7)
        SELECT id, source, target, cost, reverse_cost
        FROM edge_table
        WHERE source IN (SELECT * FROM vertices_in_graph)
        AND target IN (SELECT * FROM vertices_in_graph)
        $$,
        3, 7, false))
SELECT edge, contracted_vertices
    FROM first_dijkstra JOIN edge_table
    ON (edge = id)
    WHERE is_contracted = true;
 edge | contracted_vertices 
------+---------------------
   19 | {1,2}
(1 row)
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TODO: explain what the query</p>
</div>
<div class="highlight-python"><div class="highlight"><pre>SELECT * FROM pgr_dijkstra($$
    WITH
    -- This returns the results from case 2
    first_dijkstra AS (
        SELECT * FROM  pgr_dijkstra(
            &#39;
            WITH
            expand_vertices AS (SELECT id, unnest(contracted_vertices) AS vertex FROM edge_table_vertices_pgr),
            expand7 AS (SELECT contracted_vertices FROM edge_table_vertices_pgr
                WHERE id IN (SELECT id FROM expand_vertices WHERE vertex = 7)),
            vertices_in_graph AS (
                SELECT id  FROM edge_table_vertices_pgr WHERE is_contracted = false
                UNION
                SELECT unnest(contracted_vertices) FROM expand7)
            SELECT id, source, target, cost, reverse_cost
            FROM edge_table
            WHERE source IN (SELECT * FROM vertices_in_graph)
            AND target IN (SELECT * FROM vertices_in_graph)
            &#39;,
            3, 7, false)),

    -- edges that need expansion and the vertices to be expanded.
    edges_to_expand AS (
        SELECT edge, contracted_vertices
        FROM first_dijkstra JOIN edge_table
        ON (edge = id)
        WHERE is_contracted = true),

    vertices_in_graph AS (
        -- the nodes of the contracted solution
        SELECT node FROM first_dijkstra
        UNION
        -- the nodes of the expanding sections
        SELECT unnest(contracted_vertices) FROM edges_to_expand)

    SELECT id, source, target, cost, reverse_cost
    FROM edge_table
    WHERE source IN (SELECT * FROM vertices_in_graph)
    AND target IN (SELECT * FROM vertices_in_graph)
    -- not including the expanded edges
    AND id NOT IN (SELECT edge FROM edges_to_expand)
    $$,
    3, 7, false);
 seq | path_seq | node | edge | cost | agg_cost 
-----+----------+------+------+------+----------
   1 |        1 |    3 |    2 |    1 |        0
   2 |        2 |    2 |    4 |    1 |        1
   3 |        3 |    5 |    7 |    1 |        2
   4 |        4 |    8 |    6 |    1 |        3
   5 |        5 |    7 |   -1 |    0 |        4
(5 rows)
</pre></div>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.cs.cmu.edu/afs/cs/academic/class/15210-f12/www/lectures/lecture16.pdf">http://www.cs.cmu.edu/afs/cs/academic/class/15210-f12/www/lectures/lecture16.pdf</a></li>
<li><a class="reference external" href="http://algo2.iti.kit.edu/documents/routeplanning/geisberger_dipl.pdf">http://algo2.iti.kit.edu/documents/routeplanning/geisberger_dipl.pdf</a></li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="../../proposed.html">Experimental and Proposed functions</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../../doc/index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pgr_contractGraph.html">pgr_contractGraph - Proposed</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright pgRouting Contributors - Version 2.3.0 (pgrouting-2.3.0-dev).
      Last updated on Aug 12, 2016.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>