create or replace function createTestGrid(grid_table_name text, grid_size integer, partition_size integer) returns text as
$body$
declare
    s integer := grid_size;
    sm1 integer := grid_size - 1;
    vtab text := grid_table_name || '_vertices';
begin

-- drop and recreate the table for the grid
execute 'drop table if exists ' || quote_ident(grid_table_name) ;
execute 'create table ' || quote_ident(grid_table_name) ||
' (
  id serial not null primary key,
  source integer,
  target integer,
  cost float8
)';

-- insert all the edges
execute 'insert into ' || quote_ident(grid_table_name) || ' (source, target, cost)
select source, target, cost from
(
  (with i as (select generate_series(0,$1,1) as n),
        j as (select generate_series(1,$1,1) as n)
   select (i.n*$1 + i.n + j.n) as source, (i.n*$1 + i.n + j.n + 1) as target, 1.0::float8 as cost,
          j.n as x1, i.n as y1, j.n+1 as x2, i.n as y2
     from i, j)
   union all
  (with u as (select generate_series(0,$1,1) as n),
     v as (select generate_series(1,$2,1) as n)
  select (u.n*$1 + u.n + v.n) as source, (u.n*$1 + u.n + v.n + $2) as target, 1.0::float8 as cost,
         v.n as x1, u.n as y1, v.n as x2, u.n+$2 as y2
    from u, v where u.n < $1)
) as foo' using sm1, s;


-- create a vertices table with all the nodes in it
-- we will use this to assign quadkeys to the nodes
execute 'drop table if exists '  || quote_ident(vtab);
execute 'create table ' || quote_ident(vtab) || ' (
  id integer not null primary key,
  the_geom geometry,
  quadkey text
)';

-- insert all the nodes
execute 'insert into ' || quote_ident(vtab) || '
with i as (select generate_series(0,$1,1) as n),
     j as (select generate_series(1,$2,1) as n)
select (i.n*$1 + i.n + j.n) as id, st_astext(st_makepoint(j.n, i.n)) from i, j' using sm1, s;

-- partition the nodes and assign quadkeys
perform pgr_partitionnodes(vtab, grid_table_name, partition_size);

return 'OK';

end;
$body$
language plpgsql volatile strict;

select createTestGrid('grid25', 25, 50);

alter table grid25 add column x1 float8;
alter table grid25 add column y1 float8;
alter table grid25 add column x2 float8;
alter table grid25 add column y2 float8;
alter table grid25 rename column sgid to s_pid;
alter table grid25 rename column tgid to t_pid;
update grid25 set x1=st_x(grid25_vertices.the_geom), y1=st_y(grid25_vertices.the_geom) from grid25_vertices where grid25.source=grid25_vertices.id;
update grid25 set x2=st_x(grid25_vertices.the_geom), y2=st_y(grid25_vertices.the_geom) from grid25_vertices where grid25.target=grid25_vertices.id;
