

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pgRouting Topology &mdash; pgRouting Manual</title>
    
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.0.0 (d1a47f3 sew-devel-2_0)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/theme_extras.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="pgRouting Manual" href="../../../index.html" />
    <link rel="up" title="Common Functions" href="index.html" />
    <link rel="next" title="pgRouting Node Network" href="pgrouting_node_network.html" />
    <link rel="prev" title="pgRouting Matching" href="pgrouting_matching.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../../_static/pgrouting.png" alt="Logo"/><h1 class="heading"><a href="../../../index.html">
          <span>pgRouting Manual</span></a></h1>
        <h2 class="heading"><span>pgRouting Topology</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="pgrouting_matching.html">pgRouting Matching</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../../doc/index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pgrouting_node_network.html">pgRouting Node Network</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="pgrouting-topology">
<span id="common-topology"></span><h1>pgRouting Topology<a class="headerlink" href="#pgrouting-topology" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Stephen Woodbridge &lt;<a class="reference external" href="mailto:woodbri&#37;&#52;&#48;swoodbridge&#46;com">woodbri<span>&#64;</span>swoodbridge<span>&#46;</span>com</a>&gt;</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">$Date: 2013-03-22 20:14:00 -5000 (Fri, 22 Mar 2013) $</td>
</tr>
<tr class="field-odd field"><th class="field-name">Revision:</th><td class="field-body">$Revision: 0000 $</td>
</tr>
<tr class="field-even field"><th class="field-name">Description:</th><td class="field-body">This is a collection of tools for building topology needed for graphs. This is primarily used when loading GIS data like shapefile.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Copyright:</th><td class="field-body">Stephen Woodbridge. This document is released under the MIT-X license.</td>
</tr>
</tbody>
</table>
<div class="section" id="topology-overview">
<h2>Topology Overview<a class="headerlink" href="#topology-overview" title="Permalink to this headline">¶</a></h2>
<p>Typically when GIS files are loaded into the data database for use with
pgRouting they do not have topology information assocatired with. For data
to create a useful topology it needs to be &#8220;noded&#8221;. This means that where two
or more roads form an intersection there ineeds to be a node at the
intersection and all the road segments need to be broken at the intersection.</p>
<p>You can use the graph analysis functions to help you see where you might
have problems in your data. If you need to node your data, we also have a
function pgr_nodeNetwork that might work for you. This function splits
ALL crossing segments and nodes them. There are some cases where this might
NOT be the right thing to do.</p>
<p>For example, when you have an overpass and underpass intersection, you do not
want these noded, but pgr_nodeNetwork does not know that is the cases and
will node them which is not good because then the router will be able to
turn off the overpass onto the underpass like it was a flat 2D intersection.</p>
<p>For those cases where topology needs to be added the following functions may
be useful. One way to prep the data for pgRouting is to add the following
columns to your table and then populate them as appropriate.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">alter</span> <span class="k">table</span> <span class="n">st</span>
    <span class="k">add</span> <span class="k">column</span> <span class="k">source</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">target</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">cost_len</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">cost_time</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">rcost_len</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">rcost_time</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">x1</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">y1</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">x2</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">y2</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">to_cost</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="k">rule</span> <span class="nb">text</span><span class="p">,</span>
    <span class="k">add</span> <span class="k">column</span> <span class="n">isolated</span> <span class="nb">integer</span><span class="p">;</span>

<span class="k">select</span> <span class="n">pgr_createTopology</span><span class="p">(</span><span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">000001</span><span class="p">,</span> <span class="s1">&#39;the_geom&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>The function pgr_createTopology() will create the &#8220;vertices_tmp&#8221; table
and populate the &#8220;source&#8221; and &#8220;target&#8221; columns. The following example
populated the remaining columns. In this example, the &#8220;fcc&#8221; column contains
feature class code and the CASE statements converts it to an average speed.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">update</span> <span class="n">st</span> <span class="k">set</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">st_startpoint</span><span class="p">(</span><span class="n">the_geom</span><span class="p">)),</span>
              <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">st_startpoint</span><span class="p">(</span><span class="n">the_geom</span><span class="p">)),</span>
              <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">st_endpoint</span><span class="p">(</span><span class="n">the_geom</span><span class="p">)),</span>
              <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">st_endpoint</span><span class="p">(</span><span class="n">the_geom</span><span class="p">)),</span>
  <span class="n">cost_len</span>  <span class="o">=</span> <span class="n">st_length_spheroid</span><span class="p">(</span><span class="n">the_geom</span><span class="p">,</span> <span class="s1">&#39;SPHEROID[&quot;WGS84&quot;,6378137,298.25728]&#39;</span><span class="p">),</span>
  <span class="n">rcost_len</span> <span class="o">=</span> <span class="n">st_length_spheroid</span><span class="p">(</span><span class="n">the_geom</span><span class="p">,</span> <span class="s1">&#39;SPHEROID[&quot;WGS84&quot;,6378137,298.25728]&#39;</span><span class="p">),</span>
  <span class="n">len_km</span> <span class="o">=</span> <span class="n">st_length_spheroid</span><span class="p">(</span><span class="n">the_geom</span><span class="p">,</span> <span class="s1">&#39;SPHEROID[&quot;WGS84&quot;,6378137,298.25728]&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">len_miles</span> <span class="o">=</span> <span class="n">st_length_spheroid</span><span class="p">(</span><span class="n">the_geom</span><span class="p">,</span> <span class="s1">&#39;SPHEROID[&quot;WGS84&quot;,6378137,298.25728]&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mi">6213712</span><span class="p">,</span>
  <span class="n">speed_mph</span> <span class="o">=</span> <span class="k">case</span> <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A10&#39;</span> <span class="k">then</span> <span class="mi">65</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A15&#39;</span> <span class="k">then</span> <span class="mi">65</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A20&#39;</span> <span class="k">then</span> <span class="mi">55</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A25&#39;</span> <span class="k">then</span> <span class="mi">55</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A30&#39;</span> <span class="k">then</span> <span class="mi">45</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A35&#39;</span> <span class="k">then</span> <span class="mi">45</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A40&#39;</span> <span class="k">then</span> <span class="mi">35</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A45&#39;</span> <span class="k">then</span> <span class="mi">35</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A50&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A60&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A61&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A62&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A64&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A70&#39;</span> <span class="k">then</span> <span class="mi">15</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A69&#39;</span> <span class="k">then</span> <span class="mi">10</span>
                   <span class="k">else</span> <span class="k">null</span> <span class="k">end</span><span class="p">,</span>
  <span class="n">speed_kmh</span> <span class="o">=</span> <span class="k">case</span> <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A10&#39;</span> <span class="k">then</span> <span class="mi">104</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A15&#39;</span> <span class="k">then</span> <span class="mi">104</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A20&#39;</span> <span class="k">then</span> <span class="mi">88</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A25&#39;</span> <span class="k">then</span> <span class="mi">88</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A30&#39;</span> <span class="k">then</span> <span class="mi">72</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A35&#39;</span> <span class="k">then</span> <span class="mi">72</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A40&#39;</span> <span class="k">then</span> <span class="mi">56</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A45&#39;</span> <span class="k">then</span> <span class="mi">56</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A50&#39;</span> <span class="k">then</span> <span class="mi">40</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A60&#39;</span> <span class="k">then</span> <span class="mi">50</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A61&#39;</span> <span class="k">then</span> <span class="mi">40</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A62&#39;</span> <span class="k">then</span> <span class="mi">40</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A64&#39;</span> <span class="k">then</span> <span class="mi">40</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A70&#39;</span> <span class="k">then</span> <span class="mi">25</span>
                   <span class="k">when</span> <span class="n">fcc</span><span class="o">=</span><span class="s1">&#39;A69&#39;</span> <span class="k">then</span> <span class="mi">15</span>
                   <span class="k">else</span> <span class="k">null</span> <span class="k">end</span><span class="p">;</span>

<span class="c1">-- Update the cost infomation based on oneway streets</span>

<span class="k">update</span> <span class="n">st</span> <span class="k">set</span>
  <span class="n">cost_time</span> <span class="o">=</span> <span class="k">case</span>
    <span class="k">when</span> <span class="n">one_way</span><span class="o">=</span><span class="s1">&#39;TF&#39;</span> <span class="k">then</span> <span class="mi">10000</span><span class="p">.</span><span class="mi">0</span>
    <span class="k">else</span> <span class="n">cost_len</span><span class="o">/</span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">speed_kmh</span><span class="p">::</span><span class="nb">numeric</span><span class="o">*</span><span class="mi">3600</span><span class="p">.</span><span class="mi">0</span>
    <span class="k">end</span><span class="p">,</span>
  <span class="n">rcost_time</span> <span class="o">=</span> <span class="k">case</span>
    <span class="k">when</span> <span class="n">one_way</span><span class="o">=</span><span class="s1">&#39;FT&#39;</span> <span class="k">then</span> <span class="mi">10000</span><span class="p">.</span><span class="mi">0</span>
    <span class="k">else</span> <span class="n">cost_len</span><span class="o">/</span><span class="mi">1000</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">speed_kmh</span><span class="p">::</span><span class="nb">numeric</span><span class="o">*</span><span class="mi">3600</span><span class="p">.</span><span class="mi">0</span>
    <span class="k">end</span><span class="p">;</span>

<span class="c1">-- clean up the database because we have updated a lot of records</span>

<span class="k">vacuum</span> <span class="k">analyze</span> <span class="k">verbose</span> <span class="n">st</span><span class="p">;</span>
</pre></div>
</div>
<dl class="docutils">
<dt>Now your database should be ready to use any (most?) of the pgRouting</dt>
<dd>algorithms.</dd>
</dl>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="pgr_createTopology">
<tt class="descname">pgr_createTopology</tt><big>(</big><em>geom_table varchar</em>, <em>tolerance double precision</em>, <em>geo_cname varchar</em>, <em>gid_cname varchar</em><big>)</big><a class="headerlink" href="#pgr_createTopology" title="Permalink to this definition">¶</a></dt>
<dd><p>Fill the source and target_id column for all lines. All line ends
with a distance less than tolerance, are assigned the same id.
This function assumes the &#8220;source&#8221; and &#8220;target&#8221; columns exist on
table &#8220;geom_table&#8221; and are of type integer or bigint.
* geom_table - name of the edge table
* tolerance  - tolerance distance used to matching nodes
* geo_cname  - the geometry column name
* gid_cname  - the edge unique identifier (INTEGER or BIGINT)</p>
</dd></dl>

<dl class="function">
<dt id="pgr_pointToId">
<tt class="descname">pgr_pointToId</tt><big>(</big><em>p</em>, <em>tolerance</em><big>)</big><a class="headerlink" href="#pgr_pointToId" title="Permalink to this definition">¶</a></dt>
<dd><p><em>This function should not be used directly. Use pgr_createTopology instead.</em></p>
<p>Inserts a point into a temporary vertices table, and return an id
of a new point or an existing point. Tolerance is the minimal distance
between existing points and the new point to create a new point.
* Returns BIGINT</p>
</dd></dl>

</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="pgrouting_matching.html">pgRouting Matching</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../../doc/index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pgrouting_node_network.html">pgRouting Node Network</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright pgRouting Contributors.
      Last updated on May 14, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>