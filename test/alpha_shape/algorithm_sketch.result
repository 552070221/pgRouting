BEGIN;
BEGIN
SET client_min_messages TO NOTICE;
SET
CREATE TABLE vertices(
    gid SERIAL,
    x FLOAT,
    y FLOAT,
    geom geometry
);
CREATE TABLE
INSERT INTO vertices (x,y) VALUES
(162, 332), (182, 299), (141, 292), (158, 264), (141, 408), (160, 400),
(177, 430), (151, 442), (155, 425), (134, 430), (126, 447), (139, 466),
(160, 471), (167, 447), (182, 466), (192, 442), (187, 413), (173, 403),
(168, 425), (153, 413), (179, 275), (163, 292), (134, 270), (143, 315),
(177, 320), (163, 311), (162, 281), (182, 255), (141, 226), (156, 235),
(173, 207), (187, 230), (204, 194), (165, 189), (145, 201), (158, 167),
(190, 165), (206, 145), (179, 153), (204, 114), (221, 138),
(243, 112), (248, 139), (177, 122), (179, 99), (196, 82),
(219, 90), (240, 75), (218, 61), (228, 53), (211, 34),
(197, 51), (179, 65), (155, 70), (165, 85), (134, 80),
(124, 58), (153, 44), (173, 34), (192, 27), (156, 19),
(119, 32), (128, 17), (138, 36), (100, 58), (112, 73),
(100, 92), (78, 100), (83, 78), (61, 63), (80, 44),
(100, 26), (60, 39), (43, 71), (34, 54), (32, 90),
(53, 104), (60, 82), (66, 99), (247, 94), (187, 180),
(221, 168);
INSERT 0 82
UPDATE vertices
SET geom = ST_makePoint(x,y);
UPDATE 82
SELECT a.path[1], a.geom
INTO delauny
FROM (SELECT (ST_dump(ST_DelaunayTriangles(ST_union(geom), 0.5, 0))).*
    FROM vertices) AS a;
SELECT 145
WITH
calculations AS (
    SELECT  DISTINCT path
    FROM (SELECT path, ST_Boundary(geom) as geom from delauny) AS t
    CROSS JOIN LATERAL generate_series(1, ST_NPoints(geom) - 1)
    AS gs(x)
    CROSS JOIN LATERAL ST_MakeLine(
        ST_PointN(geom, x),
        ST_PointN(geom, x+1)
    ) AS line(geom) where ST_length(line.geom) > 50
)
DELETE FROM delauny
WHERE path IN (SELECT path from calculations);
DELETE 24
WITH
calculations AS (
    SELECT row_number() over() AS gid, NULL::BIGINT AS source, NULL::BIGINT AS target, 1 as cost, line.geom, ST_AsText(line.geom) AS line, ST_length(line.geom) AS lenght, path
    FROM (SELECT path, ST_Boundary(geom) AS geom
        FROM delauny) AS t
    CROSS JOIN LATERAL generate_series(1, ST_NPoints(geom) - 1)
    AS gs(x)
    CROSS JOIN LATERAL ST_MakeLine(
        ST_PointN(geom, x),
        ST_PointN(geom, x+1)
    ) AS line(geom)
)
SELECT *
INTO edges FROM calculations;
SELECT 363
SELECT * from pgr_createTopology('edges', 0.5, the_geom := 'geom', id := 'gid');
NOTICE:  PROCESSING:
NOTICE:  pgr_createTopology('edges', 0.5, 'geom', 'gid', 'source', 'target', rows_where := 'true', clean := f)
NOTICE:  Performing checks, please wait .....
NOTICE:  Creating Topology, Please wait...
NOTICE:  -------------> TOPOLOGY CREATED FOR  363 edges
NOTICE:  Rows with NULL geometry or NULL id: 0
NOTICE:  Vertices table for table public.edges is: public.edges_vertices_pgr
NOTICE:  ----------------------------------------------
 pgr_createtopology
--------------------
 OK
(1 row)

WITH
centralEdges AS (
    SELECT a.gid
    FROM edges AS a
    LEFT JOIN edges AS b
    ON(a.source = b.target AND a.target = b.source)
    WHERE b.gid IS NOT NULL)

DELETE FROM edges
WHERE gid IN (SELECT gid FROM centralEdges);
DELETE 324
WITH
connected AS (
    SELECT * FROM pgr_connectedComponents('SELECT gid as id, source, target, cost FROM edges')
),
the_geom AS (
    SELECT component, geom FROM edges
    JOIN connected ON (source = node)
    UNION
    SELECT component, geom FROM edges
    JOIN connected ON (target = node)
)
SELECT component, st_linemerge(ST_collect(geom)) FROM the_geom GROUP BY component;
 component |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st_linemerge
-----------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
         1 | 01020000000A0000000000000000805F400000000000F07B400000000000A061400000000000807940000000000000644000000000000079400000000000A06540000000000030794000000000006067400000000000D0794000000000000068400000000000A07B400000000000C066400000000000207D4000000000000064400000000000707D4000000000006061400000000000207D400000000000805F400000000000F07B40
        12 | 01020000001F0000000000000000004040000000000080564000000000000041400000000000004B400000000000004E40000000000080434000000000000059400000000000003A40000000000000604000000000000031400000000000806340000000000000334000000000000068400000000000003B400000000000606A4000000000000041400000000000806C400000000000804A400000000000006E400000000000C052400000000000E06E4000000000008057400000000000006F4000000000006061400000000000A06B4000000000000065400000000000806940000000000040684000000000006067400000000000C06C400000000000C066400000000000E06F400000000000C066400000000000B072400000000000206640000000000000744000000000004064400000000000C074400000000000E061400000000000B073400000000000C060400000000000E070400000000000A061400000000000406C40000000000020624000000000002069400000000000C063400000000000E0644000000000002066400000000000805E400000000000A0644000000000004055400000000000C06040000000000000544000000000000059400000000000005740000000000080534000000000000059400000000000804A400000000000005A4000000000000040400000000000805640
(2 rows)

ROLLBACK;
ROLLBACK
